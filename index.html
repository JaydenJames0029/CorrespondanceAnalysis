<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Correspondence Analysis</title>
  <link rel="stylesheet" href="styles.css">
  <!-- CDN first, fallback to local vendor copies to avoid 404s when hosted -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js" onerror="this.onerror=null;this.src='vendor/xlsx.full.min.js';"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js" onerror="this.onerror=null;this.src='vendor/chart.umd.min.js';"></script>
</head>
<body>
  <header class="hero">
    <div>
      <p class="eyebrow">Weisen-U</p>
      <h1>Correspondence Analysis</h1>
      <p class="lede">Upload the latest query workbook, pick the companies and disciplines you care about, and the site will recreate the deliverable-style summaries, revision tables, and charts.</p>
      <div class="cta-row">
        <label class="file-button">
          <input id="file-input" type="file" accept=".xlsx,.xls">
          <span>Upload query</span>
        </label>
        <button id="clear-btn" class="ghost">Reset filters</button>
        <button id="export-btn" class="ghost">Export view to Excel</button>
      </div>
      <p class="hint">Tip: the site adapts to the columns present in the uploaded query and dedupes to the latest revision per document.</p>
    </div>
  </header>

  <main class="shell">
    <section class="panel filters">
      <div class="panel-header">
        <h2>Filters</h2>
        <div class="meta" id="file-meta">No file loaded</div>
      </div>
      <div class="filters-grid">
        <div class="filter">
          <label for="origin-filter">Originating company</label>
          <select id="origin-filter" multiple></select>
        </div>
        <div class="filter">
          <label for="recipient-filter">Recipient company</label>
          <select id="recipient-filter" multiple></select>
        </div>
        <div class="filter">
          <label for="discipline-filter">Discipline</label>
          <select id="discipline-filter" multiple></select>
        </div>
        <div class="filter">
          <label for="status-filter">Correspondence status</label>
          <select id="status-filter" multiple></select>
        </div>
        <div class="filter">
          <label for="verdict-filter">Final review verdict</label>
          <select id="verdict-filter" multiple></select>
        </div>
        <div class="filter">
          <label for="issue-filter">Issue reason</label>
          <select id="issue-filter" multiple></select>
        </div>
        <div class="filter">
          <label for="reason-text-filter">Issue reason text</label>
          <select id="reason-text-filter" multiple></select>
        </div>
        <div class="filter">
          <label for="revision-filter">Revision</label>
          <select id="revision-filter" multiple></select>
        </div>
        <div class="filter">
          <label for="type-filter">Correspondence type</label>
          <select id="type-filter" multiple></select>
        </div>
        <div class="filter">
          <label for="search-input">Search (document, title, correspondence no.)</label>
          <input id="search-input" type="search" placeholder="e.g. SG532-KFW-00-EL-LST-0001">
        </div>
      </div>
    </section>

    <section class="panel stats">
      <div class="panel-header">
        <h2>At a glance</h2>
      </div>
      <div class="stat-grid">
        <div class="stat-card">
          <p class="label">Rows loaded</p>
          <p class="value" id="rows-loaded">0</p>
          <p class="sub" id="rows-loaded-sub">documents + correspondences</p>
        </div>
        <div class="stat-card">
          <p class="label">Unique documents</p>
          <p class="value" id="doc-count">0</p>
          <p class="sub" id="doc-count-sub">latest revision per document</p>
        </div>
        <div class="stat-card">
          <p class="label">Under review</p>
          <p class="value" id="under-review">0</p>
          <p class="sub" id="under-review-sub">open reviews (latest per document)</p>
        </div>
        <div class="stat-card">
          <p class="label">Overdue</p>
          <p class="value" id="overdue-count">0</p>
          <p class="sub" id="overdue-sub">response due date passed</p>
        </div>
      </div>
    </section>

    <section class="panel summary">
      <div class="panel-header">
        <h2>Discipline summary</h2>
        <p class="meta">Mimics the pivot tables in the deliverables sheet.</p>
      </div>
      <div class="table-wrap two-col">
        <div>
          <h3>Total drawings/documents</h3>
          <table id="discipline-totals"></table>
        </div>
        <div>
          <h3>Status by discipline</h3>
          <table id="status-pivot"></table>
        </div>
      </div>
    </section>

    <section class="panel charts">
      <div class="panel-header">
        <h2>Charts</h2>
        <p class="meta">Auto-updates with the current filters.</p>
      </div>
      <div class="chart-grid">
        <div class="chart-card">
          <p>Status distribution</p>
          <canvas id="status-chart" height="200"></canvas>
        </div>
        <div class="chart-card">
          <p>Discipline mix</p>
          <canvas id="discipline-chart" height="200"></canvas>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>Open reviews & resubmissions</h2>
        <p class="meta">Documents that are Under Review or flagged for resubmission, with per-revision issue dates.</p>
      </div>
      <div class="table-wrap" id="open-table-wrap">
        <table id="open-reviews-table"></table>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>Revision timeline (Under Review + Resubmissions)</h2>
        <p class="meta">Shows the latest date for each revision letter; duplicates are collapsed.</p>
      </div>
      <div class="table-wrap">
        <table id="revision-table"></table>
      </div>
    </section>

    <section class="panel">
      <details open class="collapsible">
        <summary>
          <div class="panel-header">
            <h2>Filtered records</h2>
            <p class="meta">All rows that match the current filters (documents + correspondences). Click to collapse.</p>
          </div>
        </summary>
        <div class="table-wrap">
          <table id="records-table"></table>
        </div>
      </details>
    </section>
  </main>

  <script src="app.js"></script>
</body>
</html>
